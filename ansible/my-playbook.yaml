---
- name: wait for ssh availability
  hosts: all
  gather_facts: no
  tasks:
    - name: Wait for SSH to come up
      wait_for:
        port: 22
        delay: 10
        timeout: 100 
        search_regex: OpenSSH
        host: "{{ ansible_host | default(inventory_hostname) }}"
      vars:
        ansible_connection: local


- name: setup and install docker
  hosts: all
  become: yes
  #become_user: root # not needed as become user is root by default
  tasks: 
    - name: Install packages
      dnf:
        name: 
          - docker
        update_cache: yes
        state: present 
    - name: install docker-compose  
      get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-{{lookup('pipe', 'uname -m')}} 
        dest: /usr/local/bin/docker-compose 
        mode: +x 
    - name: create docker compose plugin directory
      file:
        path: /usr/local/lib/docker/cli-plugins
        state: directory
        mode: '0755'
    - name: create symlink for docker compose v2
      file:
        src: /usr/local/bin/docker-compose
        dest: /usr/local/lib/docker/cli-plugins/docker-compose
        state: link
    - name: Start Docker service
      systemd:
        name: docker
        state: started